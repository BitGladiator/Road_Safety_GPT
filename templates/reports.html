<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reports - Road Safety GPT</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #10a37f;
        --primary-dark: #0d8c6c;
        --primary-light: rgba(16, 163, 127, 0.1);
        --bg-dark: #343541;
        --bg-darker: #202123;
        --bg-message: #444654;
        --text-light: #ffffff;
        --text-muted: #9ca3af;
        --border: #4b5563;
        --border-light: #565869;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-dark);
        color: var(--text-light);
        min-height: 100vh;
      }

      .reports-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      
      /* Navigation Header */
      .nav-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
        gap: 16px;
      }
      
      .back-button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s ease;
        white-space: nowrap;
      }
      
      .back-button:hover {
        background: var(--primary-dark);
      }
      
      .back-button::before {
        content: "←";
        font-size: 16px;
      }

      .header {
        text-align: center;
        flex: 1;
        min-width: 300px;
      }

      .header h1 {
        color: var(--text-light);
        margin-bottom: 8px;
        font-size: 24px;
        font-weight: 600;
      }

      .header p {
        color: var(--text-muted);
        font-size: 14px;
      }

      .report-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
        flex: 1;
      }

      .report-card {
        background: var(--bg-message);
        padding: 24px;
        border-radius: 8px;
        border: 1px solid var(--border-light);
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .report-card:hover {
        border-color: var(--primary);
        background: rgba(16, 163, 127, 0.05);
      }

      .report-card h3 {
        color: var(--text-light);
        margin-bottom: 12px;
        font-size: 18px;
        font-weight: 600;
      }

      .report-card p {
        color: var(--text-muted);
        margin-bottom: 20px;
        font-size: 14px;
        line-height: 1.5;
        flex: 1;
      }

      .btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s ease;
        width: 100%;
        margin-top: auto;
      }

      .btn:hover {
        background: var(--primary-dark);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .priority-list {
        background: var(--bg-message);
        padding: 24px;
        border-radius: 8px;
        border: 1px solid var(--border-light);
        margin-top: 24px;
      }

      .priority-list h3 {
        color: var(--text-light);
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: 600;
      }

      .priority-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 16px;
        border-bottom: 1px solid var(--border-light);
        gap: 16px;
      }

      .priority-item:last-child {
        border-bottom: none;
      }

      .priority-high {
        border-left: 4px solid #dc3545;
      }

      .priority-medium {
        border-left: 4px solid #fd7e14;
      }

      .priority-low {
        border-left: 4px solid #198754;
      }

      .priority-content {
        flex: 1;
        min-width: 0;
      }

      .priority-content strong {
        display: block;
        margin-bottom: 4px;
        color: var(--text-light);
        font-size: 14px;
      }

      .priority-meta {
        color: var(--text-muted);
        font-size: 12px;
      }

      .priority-details {
        text-align: right;
        min-width: 120px;
      }

      .priority-badge {
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 8px;
      }

      .badge-high {
        background: #dc3545;
        color: white;
      }

      .badge-medium {
        background: #fd7e14;
        color: white;
      }

      .badge-low {
        background: #198754;
        color: white;
      }

      .priority-info {
        font-size: 12px;
        color: var(--text-muted);
      }

      .loading {
        display: none;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin: 16px 0;
        padding: 12px;
      }

      .loading.active {
        display: flex;
      }

      .dots {
        display: flex;
        gap: 4px;
      }

      .dot {
        width: 6px;
        height: 6px;
        background: var(--primary);
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }

      .dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%, 80%, 100% {
          transform: scale(0.8);
        }
        40% {
          transform: scale(1);
        }
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        color: var(--text-muted);
        padding: 40px 20px;
        font-size: 14px;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .reports-container {
          padding: 16px;
        }

        .nav-header {
          flex-direction: column;
          text-align: center;
          gap: 16px;
        }

        .header {
          min-width: auto;
          order: -1;
        }

        .back-button {
          align-self: flex-start;
        }

        .report-actions {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .report-card {
          padding: 20px;
        }

        .priority-item {
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
        }

        .priority-details {
          text-align: left;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .priority-info {
          text-align: right;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 20px;
        }

        .report-card {
          padding: 16px;
        }

        .priority-list {
          padding: 16px;
        }

        .priority-item {
          padding: 12px;
        }
      }

      /* Scrollbar */
      body::-webkit-scrollbar {
        width: 6px;
      }

      body::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <div class="reports-container">
      <!-- Navigation Header -->
      <div class="nav-header">
        <a href="/" class="back-button">Back to Home</a>
        <div class="header">
          <h1>Analytics & Reports</h1>
          <p>Generate comprehensive reports and analytics for road safety interventions</p>
        </div>
        <div style="width: 120px;" class="header-spacer"></div>
      </div>

      <div class="report-actions">
        <div class="report-card">
          <h3>PDF Compliance Report</h3>
          <p>
            Generate a detailed PDF report with compliance analysis, intervention recommendations, and standards compliance tracking.
          </p>
          <button class="btn" onclick="generatePDFReport()">
            Generate PDF Report
          </button>
          <div class="loading" id="pdfLoading">
            <div class="dots">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
            <span>Generating PDF report...</span>
          </div>
        </div>

        <div class="report-card">
          <h3>Excel Analytics Report</h3>
          <p>
            Export comprehensive data to Excel with detailed analytics, cost estimations, priority rankings, and intervention metrics.
          </p>
          <button class="btn" onclick="generateExcelReport()">
            Generate Excel Report
          </button>
          <div class="loading" id="excelLoading">
            <div class="dots">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
            <span>Generating Excel report...</span>
          </div>
        </div>

        <div class="report-card">
          <h3>Priority Analysis</h3>
          <p>
            View interventions ranked by priority level with detailed cost estimates, implementation timelines, and compliance requirements.
          </p>
          <button class="btn" onclick="loadPriorityRanking()">
            Load Priority Ranking
          </button>
          <div class="loading" id="priorityLoading">
            <div class="dots">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
            <span>Loading priority rankings...</span>
          </div>
        </div>
      </div>

      <div class="priority-list" id="priorityList" style="display: none">
        <h3>Intervention Priority Ranking</h3>
        <div id="priorityContent" class="empty-state">
          No priority data loaded. Click "Load Priority Ranking" to view interventions.
        </div>
      </div>
    </div>

    <script>
      async function generatePDFReport() {
        const loading = document.getElementById("pdfLoading");
        const button = event.target;
        
        loading.style.display = "flex";
        button.disabled = true;

        try {
          const response = await fetch("/api/generate-pdf-report");

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = `road_safety_report_${new Date()
              .toISOString()
              .slice(0, 16)
              .replace(/[-:]/g, "")}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // Show success feedback
            button.textContent = "✓ Downloaded";
            setTimeout(() => {
              button.textContent = "Generate PDF Report";
            }, 2000);
          } else {
            const errorData = await response.json();
            alert("Error: " + (errorData.error || "Failed to generate PDF report"));
          }
        } catch (error) {
          alert("Error generating PDF report: " + error.message);
        } finally {
          loading.style.display = "none";
          button.disabled = false;
        }
      }

      async function generateExcelReport() {
        const loading = document.getElementById("excelLoading");
        const button = event.target;
        
        loading.style.display = "flex";
        button.disabled = true;

        try {
          const response = await fetch("/api/generate-excel-report");

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = `road_safety_analytics_${new Date()
              .toISOString()
              .slice(0, 16)
              .replace(/[-:]/g, "")}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // Show success feedback
            button.textContent = "✓ Downloaded";
            setTimeout(() => {
              button.textContent = "Generate Excel Report";
            }, 2000);
          } else {
            const errorData = await response.json();
            alert("Error: " + (errorData.error || "Failed to generate Excel report"));
          }
        } catch (error) {
          alert("Error generating Excel report: " + error.message);
        } finally {
          loading.style.display = "none";
          button.disabled = false;
        }
      }

      async function loadPriorityRanking() {
        const loading = document.getElementById("priorityLoading");
        const button = event.target;
        const priorityList = document.getElementById("priorityList");
        const priorityContent = document.getElementById("priorityContent");

        loading.style.display = "flex";
        button.disabled = true;
        priorityList.style.display = "none";

        try {
          const response = await fetch("/api/analytics/priority-ranking");
          const data = await response.json();

          if (data.success && data.interventions && data.interventions.length > 0) {
            priorityContent.innerHTML = data.interventions
              .map(
                (intervention) => `
                  <div class="priority-item priority-${intervention.priority.toLowerCase()}">
                    <div class="priority-content">
                      <strong>${intervention.intervention_name}</strong>
                      <div class="priority-meta">
                        ${intervention.category} • ${intervention.standard_code} ${intervention.clause}
                      </div>
                    </div>
                    <div class="priority-details">
                      <span class="priority-badge badge-${intervention.priority.toLowerCase()}">
                        ${intervention.priority}
                      </span>
                      <div class="priority-info">
                        <div>${intervention.estimated_cost}</div>
                        <div>${intervention.timeline}</div>
                      </div>
                    </div>
                  </div>
                `
              )
              .join("");

            priorityList.style.display = "block";
            
            button.textContent = "✓ Loaded";
            setTimeout(() => {
              button.textContent = "Load Priority Ranking";
            }, 2000);
          } else {
            priorityContent.innerHTML = '<div class="empty-state">No intervention data available</div>';
            priorityList.style.display = "block";
          }
        } catch (error) {
          priorityContent.innerHTML = '<div class="empty-state">Error loading priority data</div>';
          priorityList.style.display = "block";
          alert("Error loading priority ranking: " + error.message);
        } finally {
          loading.style.display = "none";
          button.disabled = false;
        }
      }

      window.addEventListener('resize', function() {
        const spacer = document.querySelector('.header-spacer');
        if (window.innerWidth <= 768) {
          spacer.style.display = 'none';
        } else {
          spacer.style.display = 'block';
        }
      });
      window.dispatchEvent(new Event('resize'));
    </script>
  </body>
</html>